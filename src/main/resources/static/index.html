<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MoonTV Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/artplayer/dist/artplayer.css" />
    <script src="https://unpkg.com/hls.js@latest"></script>
    <script src="https://unpkg.com/artplayer/dist/artplayer.js"></script>
    <style>
        :root {
            --bg:#0f172a;
            --card:#1f2a44;
            --text:#e3e8ff;
            --muted:#9ca3af;
            --radius:0.75rem;
        }
        [data-theme="light"] {
            --bg:#f5f7fa;
            --card:#ffffff;
            --text:#1f2937;
            --muted:#6b7280;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
        }
        .glass {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }
        .rounded-card {
            border-radius: 1rem;
        }
    </style>
</head>
<body data-theme="dark" class="min-h-screen flex flex-col">
<header class="flex flex-wrap items-center justify-between px-6 py-4 shadow-md" style="background: var(--card);">
    <div class="flex items-center gap-3 flex-1 min-w-[200px]">
        <div class="text-2xl font-bold">ğŸ¬ MoonTV Lite</div>
        <div class="hidden sm:inline text-sm text-[var(--muted)]">å½±è§†æœç´¢ä¸æ’­æ”¾</div>
    </div>
    <div class="flex items-center gap-4 flex-1 justify-end min-w-[300px]">
        <div class="relative flex-1 max-w-md">
            <input id="searchInput" type="text" placeholder="æœç´¢ç”µå½±/ç”µè§†å‰§" class="rounded-full px-4 py-2 w-full focus:outline-none bg-[rgba(255,255,255,0.07)] placeholder:opacity-60" />
            <button id="searchBtn" class="absolute right-1 top-1/2 -translate-y-1/2 px-4 py-2 bg-blue-500 rounded-full text-sm hover:brightness-105">æœç´¢</button>
        </div>
        <button id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜" class="p-2 rounded-full hover:bg-white/10">
            <svg id="icon-theme" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M17.36 17.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M17.36 6.64l1.42-1.42"/></svg>
        </button>
    </div>
</header>

<main class="flex-1 overflow-auto px-6 py-6 space-y-6">
    <!-- æœç´¢ç»“æœ -->
    <section id="searchSection">
        <h2 class="text-xl font-semibold mb-2">æœç´¢ç»“æœ</h2>
        <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="pagination" class="flex justify-center gap-2 mt-4"></div>
    </section>

    <!-- è¯¦æƒ…ä¸æ’­æ”¾ -->
    <section id="detailSection" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6">
            <div class="flex-1">
                <div id="playerWrapper" class="mb-4 rounded-card overflow-hidden shadow-lg">
                    <!-- åŸç”Ÿ video ä½œä¸º fallback -->
                    <div id="player" style="position: relative; width:100%; padding-top:56.25%; background:#000;">
                        <!-- æ’­æ”¾å™¨ç”± JS æ³¨å…¥ -->
                    </div>
                </div>
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 text-sm break-all bg-[rgba(255,255,255,0.08)] p-2 rounded">
                        <div class="font-medium mb-1">å½“å‰æ’­æ”¾åœ°å€</div>
                        <div id="playUrlDisplay">åŠ è½½ä¸­...</div>
                        <div class="mt-1 flex gap-2">
                            <button id="copyBtn" class="px-3 py-1 text-xs bg-blue-500 rounded hover:brightness-105">å¤åˆ¶é“¾æ¥</button>
                            <button id="retryBtn" class="px-3 py-1 text-xs bg-yellow-500 rounded hover:brightness-105">é‡è¯•æ’­æ”¾</button>
                        </div>
                        <div id="playError" class="mt-2 text-red-400 text-xs hidden"></div>
                    </div>
                </div>
            </div>
            <div class="w-full lg:w-1/3 space-y-3">
                <div class="p-4 rounded-xl glass shadow">
                    <h3 id="vodTitle" class="text-2xl font-bold mb-1">æ ‡é¢˜</h3>
                    <div id="vodMeta" class="text-sm text-[var(--muted)] mb-2">ç±»å‹ Â· å¹´ä»½ Â· æ¼”å‘˜</div>
                    <p id="vodDesc" class="text-sm leading-relaxed">ç®€ä»‹...</p>
                </div>
                <div class="p-4 rounded-xl glass shadow">
                    <h4 class="font-semibold mb-2">å‰§é›† / æº</h4>
                    <div id="playList" class="flex flex-col gap-3"></div>
                </div>
            </div>
        </div>
        <button id="backBtn" class="mt-6 inline-flex items-center gap-2 text-sm px-4 py-2 bg-[rgba(255,255,255,0.07)] rounded hover:bg-[rgba(255,255,255,0.1)]">
            â† è¿”å›æœç´¢
        </button>
    </section>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="text-center text-[var(--muted)]">
        è¯·è¾“å…¥å…³é”®è¯å¹¶ç‚¹å‡»æœç´¢å¼€å§‹ã€‚
    </div>
</main>

<footer class="text-center py-4 text-xs" style="background: var(--card);">
    Â© 2025 MoonTV Lite. æ¥å£ç”±åç«¯æä¾›ã€‚
</footer>

<script>
    // ä¸»é¢˜åˆ‡æ¢
    const themeToggle = document.getElementById('themeToggle');
    let dark = true;
    function applyTheme() {
        document.body.setAttribute('data-theme', dark ? 'dark' : 'light');
    }
    themeToggle.addEventListener('click', () => {
        dark = !dark;
        applyTheme();
    });
    applyTheme();

    // å…ƒç´ 
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsEl = document.getElementById('results');
    const emptyState = document.getElementById('emptyState');
    const detailSection = document.getElementById('detailSection');
    const searchSection = document.getElementById('searchSection');
    const backBtn = document.getElementById('backBtn');
    const playList = document.getElementById('playList');
    const vodTitle = document.getElementById('vodTitle');
    const vodMeta = document.getElementById('vodMeta');
    const vodDesc = document.getElementById('vodDesc');
    const playUrlDisplay = document.getElementById('playUrlDisplay');
    const playError = document.getElementById('playError');
    const copyBtn = document.getElementById('copyBtn');
    const retryBtn = document.getElementById('retryBtn');
    const playerContainer = document.getElementById('player');

    let lastQuery = '';
    let currentPage = 1;
    let currentVodInfo = null;
    let playerInstance = null;
    let hlsInstance = null;
    let lastPlayUrl = '';

    // æœç´¢
    async function doSearch(q, page = 1) {
        if (!q) {
            emptyState.textContent = 'å…³é”®è¯ä¸èƒ½ä¸ºç©ºã€‚';
            return;
        }
        resultsEl.innerHTML = '';
        paginationEl.innerHTML = '';
        emptyState.style.display = 'none';
        try {
            const resp = await fetch(`/vod/search?wd=${encodeURIComponent(q)}&page=${page}`);
            const data = await resp.json();
            const list = data.list || [];
            if (list.length === 0) {
                emptyState.textContent = 'æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ã€‚';
                emptyState.style.display = 'block';
                return;
            }
            resultsEl.innerHTML = '';
            list.forEach(v => {
                const card = document.createElement('div');
                card.className = 'bg-[var(--card)] rounded-xl p-4 flex flex-col hover:shadow-xl transition cursor-pointer';
                card.innerHTML = `
            <div class="font-semibold text-lg mb-1 truncate">${v.vod_name}</div>
            <div class="text-[var(--muted)] text-sm mb-2">${v.vod_class || ''} Â· ${v.vod_year || ''}</div>
            <div class="flex gap-2 mt-auto">
              <button data-id="${v.vod_id}" class="play-btn flex-1 px-3 py-2 bg-blue-500 rounded text-white text-sm hover:brightness-105">æŸ¥çœ‹ & æ’­æ”¾</button>
            </div>
          `;
                resultsEl.appendChild(card);
            });

            // ç®€æ˜“åˆ†é¡µï¼ˆå‰/åï¼‰
            paginationEl.innerHTML = `
          <button ${page<=1?'disabled':''} data-page="${page-1}" class="px-3 py-1 rounded border border-[var(--muted)] mr-2">ä¸Šä¸€é¡µ</button>
          <span class="px-2">ç¬¬ ${page} é¡µ</span>
          <button data-page="${page+1}" class="px-3 py-1 rounded border border-[var(--muted)] ml-2">ä¸‹ä¸€é¡µ</button>
        `;
            paginationEl.querySelectorAll('button[data-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const p = parseInt(btn.getAttribute('data-page'));
                    if (p >= 1) {
                        currentPage = p;
                        doSearch(lastQuery, currentPage);
                    }
                });
            });

            document.querySelectorAll('.play-btn').forEach(b => {
                b.addEventListener('click', () => {
                    const id = b.getAttribute('data-id');
                    showDetail(id);
                });
            });
        } catch (e) {
            emptyState.textContent = 'æœç´¢å¤±è´¥ï¼Œç¨åé‡è¯•ã€‚';
            emptyState.style.display = 'block';
            console.error(e);
        }
    }

    // è¯¦æƒ…
    async function showDetail(ids) {
        try {
            const resp = await fetch(`/vod/detail?ids=${encodeURIComponent(ids)}`);
            const data = await resp.json();
            const info = (data.list && data.list[0]) || {};
            currentVodInfo = info;

            vodTitle.textContent = info.vod_name || 'æœªçŸ¥æ ‡é¢˜';
            vodMeta.textContent = `${info.vod_class || ''} Â· ${info.vod_year || ''} Â· ${info.vod_actor || ''}`;
            vodDesc.textContent = info.vod_content || 'æ— ç®€ä»‹ã€‚';

            // å‰§é›† / æº åˆ—è¡¨
            playList.innerHTML = '';
            const froms = (info.vod_play_from || '').split('$$');
            const urls = (info.vod_play_url || '').split('$$');
            froms.forEach((from, idx) => {
                const part = urls[idx] || '';
                const episodes = part.split('#').filter(Boolean);
                const block = document.createElement('div');
                block.className = 'flex flex-col gap-1';
                const title = document.createElement('div');
                title.className = 'font-medium mb-1';
                title.textContent = from || 'æº';
                block.appendChild(title);
                const epWrap = document.createElement('div');
                epWrap.className = 'flex flex-wrap gap-2';
                episodes.forEach(epRaw => {
                    const [label, raw] = epRaw.split('$');
                    const btn = document.createElement('button');
                    btn.className = 'px-2 py-1 text-xs bg-[rgba(255,255,255,0.08)] rounded hover:bg-[rgba(255,255,255,0.12)]';
                    btn.textContent = label || 'é›†';
                    btn.addEventListener('click', () => {
                        playByVodInfo(raw);
                    });
                    epWrap.appendChild(btn);
                });
                block.appendChild(epWrap);
                playList.appendChild(block);
            });

            // æ˜¾ç¤º detail è§†å›¾
            searchSection.classList.add('hidden');
            detailSection.classList.remove('hidden');
            emptyState.style.display = 'none';

            // è‡ªåŠ¨ç‚¹ç¬¬ä¸€ä¸ªå¯ç”¨é›†ï¼ˆå¦‚æœæœ‰ï¼‰
            const firstButton = playList.querySelector('button');
            if (firstButton) firstButton.click();
        } catch (e) {
            console.error(e);
            alert('è·å–è¯¦æƒ…å¤±è´¥');
        }
    }

    // æ’­æ”¾é€»è¾‘ï¼ˆæœ€é€šç”¨ï¼‰
    async function playByVodInfo(rawPlayFragment) {
        if (!currentVodInfo) return;
        resetPlayerState();
        try {
            // å…ˆå»åç«¯æ‹¿æœ€ç»ˆ m3u8 é“¾æ¥ï¼ˆä½ çš„ /vod/play é€»è¾‘ï¼‰
            const playResp = await fetch(`/vod/play?ids=${encodeURIComponent(currentVodInfo.vod_id)}`);
            let playUrl = await playResp.text();
            playUrl = playUrl.trim();
            lastPlayUrl = playUrl;
            playUrlDisplay.textContent = playUrl;
            playError.classList.add('hidden');

            // å¤åˆ¶ / é‡è¯•æŒ‰é’®çŠ¶æ€
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(playUrl).then(() => {
                    alert('å·²å¤åˆ¶æ’­æ”¾é“¾æ¥');
                });
            };
            retryBtn.onclick = () => {
                attemptPlay(playUrl);
            };

            // æ’­æ”¾
            await attemptPlay(playUrl);
        } catch (e) {
            console.error('æ’­æ”¾å¤±è´¥', e);
            showPlayError('è·å–æ’­æ”¾åœ°å€å¤±è´¥');
        }
    }

    function resetPlayerState() {
        // æ¸…æ—§å®ä¾‹
        if (playerInstance) {
            try { playerInstance.destroy(); } catch(_) {}
            playerInstance = null;
        }
        if (hlsInstance) {
            try { hlsInstance.destroy(); } catch(_) {}
            hlsInstance = null;
        }
        playerContainer.innerHTML = ''; // æ¸…ç©º
        playError.textContent = '';
        playError.classList.add('hidden');
    }

    // å°è¯•æ’­æ”¾ï¼Œå« HLS.js + åŸç”Ÿ fallback + å¤±è´¥é‡è¯•
    async function attemptPlay(url, retryCount = 0) {
        const MAX_RETRY = 2;
        clearPlayerUI();

        // åˆ›å»ºåŸç”Ÿ <video>ï¼Œç”¨äºæ‰€æœ‰æƒ…å†µï¼ˆåŒ…æ‹¬ HLS.js attachï¼‰
        const video = document.createElement('video');
        video.setAttribute('controls', '');
        video.setAttribute('playsinline', '');
        video.style.width = '100%';
        video.style.height = '100%';
        video.autoplay = false;
        video.muted = false;

        // æ¸…æ‰æ—§ dom
        playerContainer.innerHTML = '';
        playerContainer.appendChild(video);

        // Helper: onError
        const onError = (msg) => {
            if (retryCount < MAX_RETRY) {
                console.warn('æ’­æ”¾å¤±è´¥ï¼Œé‡è¯•ä¸­...', msg);
                setTimeout(() => attemptPlay(url, retryCount + 1), 1000 * (retryCount + 1));
            } else {
                showPlayError('æ’­æ”¾å¤±è´¥ï¼ˆå·²é‡è¯•ï¼‰ï¼Œå¯èƒ½æ˜¯ CORSã€æºå¤±æ•ˆæˆ–æ ¼å¼é—®é¢˜ã€‚');
            }
        };

        if (Hls.isSupported()) {
            hlsInstance = new Hls({
                // å¯åŠ  xhrSetup åš cookie/headers é€ä¼ ï¼š
                // xhrSetup: (xhr, url) => { xhr.withCredentials = true; }
            });
            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(video);
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(() => {
                    // éœ€è¦ç”¨æˆ·äº¤äº’
                });
            });
            hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                console.error('HLS.js error', data);
                if (data.fatal) {
                    hlsInstance.destroy();
                    onError(data);
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari ç›´æ¥ç”¨ src
            video.src = url;
            video.addEventListener('loadedmetadata', () => {
                video.play().catch(() => {});
            });
            video.addEventListener('error', (e) => {
                console.error('åŸç”Ÿ video æ’­æ”¾é”™è¯¯', e);
                onError(e);
            });
        } else {
            showPlayError('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ HLSï¼Œå»ºè®®ç”¨ Chrome / Safari ç°ä»£æµè§ˆå™¨æ’­æ”¾ã€‚');
            return;
        }

        // å…¨å±€å¤±è´¥æ•æ‰ï¼ˆè‹¥ video æŠ¥é”™ï¼‰
        video.addEventListener('error', (e) => {
            console.warn('è§†é¢‘ element error', e);
            onError(e);
        });
    }

    function clearPlayerUI() {
        playError.textContent = '';
        playError.classList.add('hidden');
    }

    function showPlayError(msg) {
        playError.textContent = msg;
        playError.classList.remove('hidden');
    }

    // ç»‘å®šäº‹ä»¶
    searchBtn.addEventListener('click', () => {
        const q = searchInput.value.trim();
        if (!q) return;
        lastQuery = q;
        currentPage = 1;
        doSearch(q, currentPage);
    });
    searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') searchBtn.click();
    });
    backBtn.addEventListener('click', () => {
        detailSection.classList.add('hidden');
        searchSection.classList.remove('hidden');
    });

    // åˆå§‹ focus / ç©ºçŠ¶æ€
    const paginationEl = document.getElementById('pagination');

    // æç¤ºï¼šé¡µé¢åŠ è½½åå¯ä»¥è‡ªåŠ¨æœç´¢é»˜è®¤å…³é”®è¯
    // doSearch('å¤ä»‡è€…è”ç›Ÿ', 1);
</script>
</body>
</html>
